using Microsoft.AspNetCore.Mvc;
using {{.NamespaceRoot}}.Application.Contracts.Services.{{.ModuleNameWithSuffix}};
using {{.NamespaceRoot}}.Application.Contracts.{{.EntityName}}Module;
using System;
using Volo.Abp.AspNetCore.Mvc;
using Volo.Abp.Application.Dtos;
using System.Threading.Tasks;
using Volo.Abp.EventBus.Distributed;
using Microsoft.Extensions.Caching.Distributed;
using Microsoft.AspNetCore.Authorization;
using static {{.NamespaceRoot}}.Application.Contracts.Permissions.{{.ModuleNameWithSuffix}}.{{.ModuleName}}Permissions;
using Volo.Abp;
using Volo.Abp.Domain.Entities;
using Volo.Abp.Validation;
using FluentValidation;
using Microsoft.Extensions.Logging;

namespace {{.NamespaceRoot}}.HttpApi.Controllers.{{.ModuleNameWithSuffix}}
{
    [Route("api/{{.EntityNamePlural | toLower}}")]
    public class {{.EntityName}}Controller : AbpControllerBase
    {
        private readonly I{{.EntityName}}AppService _appService;
        private readonly ILogger<{{.EntityName}}Controller> _logger;

        public {{.EntityName}}Controller(
            I{{.EntityName}}AppService appService,
            ILogger<{{.EntityName}}Controller> logger)
        {
            _appService = appService;
            _logger = logger;
        }

        [HttpGet]
        [Route("{id}")]
        [Authorize({{.EntityName}}Management.Default)]
        public virtual async Task<{{.EntityName}}Dto> GetAsync({{.PrimaryKeyType}} id)
        {
            _logger.LogInformation("API call: GetAsync for {EntityName} with Id: {Id}", "{{.EntityName}}", id);
            
            try
            {
                var result = await _appService.GetAsync(id);
                _logger.LogInformation("API call successful: GetAsync for {EntityName} with Id: {Id}", "{{.EntityName}}", id);
                return result;
            }
            catch (BusinessException)
            {
                throw;
            }
            catch (EntityNotFoundException)
            {
                throw;
            }
            catch (AbpValidationException)
            {
                throw;
            }
            catch (ValidationException)
            {
                throw;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Unexpected error in API call GetAsync for {EntityName} with Id: {Id}", "{{.EntityName}}", id);
                throw new UserFriendlyException("An unexpected error occurred. Please try again later.");
            }
        }

        [HttpGet]
        [Authorize({{.EntityName}}Management.Default)]
        public virtual async Task<PagedResultDto<{{.EntityName}}Dto>> GetListAsync([FromQuery] PagedAndSortedResultRequestDto input)
        {
            _logger.LogInformation("API call: GetListAsync for {EntityName} with SkipCount: {SkipCount}, MaxResultCount: {MaxResultCount}", 
                "{{.EntityName}}", input.SkipCount, input.MaxResultCount);
            
            try
            {
                var result = await _appService.GetListAsync(input);
                _logger.LogInformation("API call successful: GetListAsync for {EntityName} with {TotalCount} items", 
                    "{{.EntityName}}", result.TotalCount);
                return result;
            }
            catch (BusinessException)
            {
                throw;
            }
            catch (EntityNotFoundException)
            {
                throw;
            }
            catch (AbpValidationException)
            {
                throw;
            }
            catch (ValidationException)
            {
                throw;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Unexpected error in API call GetListAsync for {EntityName}", "{{.EntityName}}");
                throw new UserFriendlyException("An unexpected error occurred. Please try again later.");
            }
        }

        [HttpPost]
        [Authorize({{.EntityName}}Management.Create)]
        public virtual async Task<{{.EntityName}}Dto> CreateAsync(Create{{.EntityName}}Dto input)
        {
            _logger.LogInformation("API call: CreateAsync for {EntityName}", "{{.EntityName}}");
            
            try
            {
                var result = await _appService.CreateAsync(input);
                _logger.LogInformation("API call successful: CreateAsync for {EntityName} with Id: {Id}", 
                    "{{.EntityName}}", result.Id);
                return result;
            }
            catch (BusinessException)
            {
                throw;
            }
            catch (EntityNotFoundException)
            {
                throw;
            }
            catch (AbpValidationException)
            {
                throw;
            }
            catch (ValidationException)
            {
                throw;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Unexpected error in API call CreateAsync for {EntityName}", "{{.EntityName}}");
                throw new UserFriendlyException("An unexpected error occurred. Please try again later.");
            }
        }

        [HttpPut]
        [Route("{id}")]
        [Authorize({{.EntityName}}Management.Update)]
        public virtual async Task<{{.EntityName}}Dto> UpdateAsync({{.PrimaryKeyType}} id, Update{{.EntityName}}Dto input)
        {
            _logger.LogInformation("API call: UpdateAsync for {EntityName} with Id: {Id}", "{{.EntityName}}", id);
            
            try
            {
                var result = await _appService.UpdateAsync(id, input);
                _logger.LogInformation("API call successful: UpdateAsync for {EntityName} with Id: {Id}", 
                    "{{.EntityName}}", id);
                return result;
            }
            catch (BusinessException)
            {
                throw;
            }
            catch (EntityNotFoundException)
            {
                throw;
            }
            catch (AbpValidationException)
            {
                throw;
            }
            catch (ValidationException)
            {
                throw;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Unexpected error in API call UpdateAsync for {EntityName} with Id: {Id}", "{{.EntityName}}", id);
                throw new UserFriendlyException("An unexpected error occurred. Please try again later.");
            }
        }

        [HttpDelete]
        [Route("{id}")]
        [Authorize({{.EntityName}}Management.Delete)]
        public virtual async Task DeleteAsync({{.PrimaryKeyType}} id)
        {
            _logger.LogInformation("API call: DeleteAsync for {EntityName} with Id: {Id}", "{{.EntityName}}", id);
            
            try
            {
                await _appService.DeleteAsync(id);
                _logger.LogInformation("API call successful: DeleteAsync for {EntityName} with Id: {Id}", 
                    "{{.EntityName}}", id);
            }
            catch (BusinessException)
            {
                throw;
            }
            catch (EntityNotFoundException)
            {
                throw;
            }
            catch (AbpValidationException)
            {
                throw;
            }
            catch (ValidationException)
            {
                throw;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Unexpected error in API call DeleteAsync for {EntityName} with Id: {Id}", "{{.EntityName}}", id);
                throw new UserFriendlyException("An unexpected error occurred. Please try again later.");
            }
        }
    }
}

